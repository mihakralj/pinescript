// The MIT License (MIT)
// Â© mihakralj
//@version=6
indicator("Ehlers Ultrasmooth Filter", "EHUltra", overlay=true)

//@function Calculates Ehlers Ultrasmooth Filter
//@param source Series to calculate EHUS from
//@param length Number of bars used in the calculation
//@returns EHUS value with optimized smoothing
ehus(series float src, simple int length) =>
    a1 = math.exp(-1.414 * math.pi / length)
    b1 = 2 * a1 * math.cos(1.414 * 180 / length)
    c2 = b1
    c3 = -a1 * a1
    c1 = (1 + c2 - c3) / 4
    var float us = src
    if bar_index < 3
        us := src
    else
        us := (1 - c1) * src + (2 * c1 - c2) * src[1] - (c1 + c3) * src[2] + c2 * us[1] + c3 * us[2]
    us

// ---------- Main loop ----------

// Inputs
i_length = input.int(20, "Length", minval=1)
i_source = input.source(close, "Source")

// Calculation
ehus_value = ehus(i_source, i_length)

// Plot
plot(ehus_value, "EHUltra", color.new(color.blue, 0), 2)

// Alert
alertcondition(ta.cross(i_source, ehus_value), "Price Crosses EHUltra", "Price crossed EHUltra on {{ticker}}")
